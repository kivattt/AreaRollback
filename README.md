# AreaRollback
Server mod that lets you select an area with a wooden axe, then rollback that area from a backup folder or ZIP file. \
Install the mod, start then `stop` your server, put your backups folder filepath in `mods/AreaRollback/config.txt` and you're set! 

## Commands (OP-only)
```
/rollback
```
List all backups in your `backups-dir` folder.

```
/rollback <backup name>
```
Roll back the selected area to the backup.

```
/rollbackversion (You don't need OP to run this command)
```
Displays mod version

<details>
<summary>Extra fun commands</summary>

```
/rollbackflipdimension
```
All subsequent rollbacks will copy from the opposite dimension.

```
/rollbackfromself
```
Rollback by copying from the servers own region files. \
Only useful for flipping the dimension of an area locally for fun

</details>

## Notes
Rollbacks **CAN NOT BE UNDONE**! Make a backup first if you want to keep the current state of the world.

Rollbacks can take a long time if the selected area is large enough. \
Rolling back a `51 x 54 x 109` area takes 13.4 seconds on my `AMD Ryzen 7 3700x @ 4.1GHz` server

If your backup doesn't have an area you're `/rollback`-ing, that area will be untouched. \
I could make it reset the area back to the default worldgen, but it isn't implemented yet.

<details>
<summary>Config example</summary>

This is what the default empty `mods/AreaRollback/config.txt` looks like:
```
# Default empty config file generated by AreaRollbackServer

# REQUIRED! The folder containing all your backups as folders and/or .zip files
backups-dir=

# Only change this if you're really low on disk space and have another drive
# Since it is a temporary folder, it will be deleted after using /rollback, so don't be alarmed if it's suddenly missing
# When left empty or missing, the default is mods/AreaRollback/tmp-dont-delete
temporary-dir=
```
You only need to set the `backups-dir`. \
It has to be an absolute path:
```
# This works
backups-dir = /home/user/reindev-server/folder

# But these don't
backups-dir = ./folder
backups-dir = ~/folder
```
</details>

## Known issues
You may want to rollback twice to make sure blocks like torches are placed correctly, since they require a block to attach to.

`/rollback` will halt the entire server while it's rolling back, if it's a big enough area your players will time out. \
I haven't experimented with any way to circumvent this, but I suspect it might be impossible without \
changing a lot of ReIndev source code.

Rolling back can cause blocks (pre or post rollback) like torches, crates and chests to drop items, potentially duplicating items

## Technical notes
The reason you have to re-join the server to see the changes after a rollback is because we don't use `setBlockAndMetadataWithNotify`. \
This is because it immediately triggers `onNeighborBlockChange` on every block, which will for example cause portal blocks to \
notice they're in an unfinished portal, and then replace themselves with air.

## TODOs (sorted by priority)
- Add a toggle command for including entities in rollbacks
- Conditionally use `setBlockAndMetadataWithNotify` or `setBlockAndMetadata` based on if block implements `onNeighborBlockChange` (reflection)
- (Maybe...) Allow relative paths in config, have to check File::isAbsolute and add `areaRollbackBasePath`
- ^ Otherwise, consider adding a command to flip between `setBlockAndMetadataWithNotify` and `setBlockAndMetadata`